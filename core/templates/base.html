<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest.Uz | Real Vaqtda Moliyaviy Bozor</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white text-gray-900 transition-colors duration-300 flex flex-col min-h-screen">

    <!-- Navbar -->
    <header class="bg-white shadow-md fixed top-0 left-0 w-full z-50">
        <div class="max-w-7xl mx-auto flex items-center justify-between p-4">
            <h1 class="text-2xl font-bold text-blue-700">ðŸ“Š Invest.Uz</h1>

            <nav class="hidden md:flex space-x-6">
                <a href="{% url 'landingpage' %}" class="hover:text-blue-600">Bosh sahifa</a>
                <a href="{% url 'strategyoverview' %}" class="hover:text-blue-600">Test</a>
                <a href="{% url 'performanceanalytics' %}" class="hover:text-blue-600">Natijalar</a>
                <a href="{% url 'calendar___' %}" class="hover:text-blue-600">Kalendar</a>
            </nav>

            <div class="flex items-center space-x-4">
                {% if request.user.is_authenticated %}
                <div class="relative">
                    <button id="profileBtn" aria-label="Profil menyusini ochish">
                        {% if request.user.profile.profile_image %}
                        <img src="{{ request.user.profile.profile_image.url }}" alt="Profil rasmi"
                            class="w-10 h-10 rounded-full border-2 border-green-500">
                        {% else %}
                        <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">ðŸ‘¤</div>
                        {% endif %}
                    </button>
                    <div id="profileMenu" class="hidden absolute right-0 mt-2 w-48 bg-white shadow-lg rounded-lg">
                        <a href="{% url 'profile_details' %}" class="block px-4 py-2 hover:bg-gray-100">Profil</a>
                        <a href="{% url 'strategyoverview' %}" class="block px-4 py-2 hover:bg-gray-100">Testlarim</a>
                        <a href="{% url 'logout' %}" class="block px-4 py-2 text-red-600 hover:bg-gray-100">Chiqish</a>
                    </div>
                </div>
                {% else %}
                <a href="{% url 'signup' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-500">Roâ€˜yxatdan oâ€˜tish</a>
                <a href="{% url 'login' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-500">Kirish</a>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Asosiy kontent -->
    <main class="flex-1 mt-24 max-w-7xl mx-auto w-full p-6">
        {% block content %}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Narxlar -->
            <section class="p-6 rounded-lg shadow-md bg-white">
                <h2 class="text-xl font-bold mb-4 text-blue-700">ðŸ“Š Real Vaqtdagi Narxlar</h2>
                <ul id="prices-list" class="space-y-2">
                    <li>Yuklanmoqda...</li>
                </ul>
                <p class="text-sm text-gray-500 mt-2">
                    Oxirgi yangilanish: <span id="update-time">---</span>
                </p>
            </section>

            <!-- Yangiliklar -->
            <section class="p-6 rounded-lg shadow-md bg-white">
                <h2 class="text-xl font-bold mb-4 text-blue-700">ðŸ“° Moliyaviy Yangiliklar</h2>
                <ul class="space-y-3">
                    {% if news %}
                    {% for article in news %}
                    <li>
                        <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer"
                            class="block text-blue-600 hover:underline font-semibold">
                            {{ article.title }}
                        </a>
                        <p class="text-sm text-gray-600">{{ article.description }}</p>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li>Hozircha yangiliklar mavjud emas.</li>
                    {% endif %}
                </ul>
            </section>

            <!-- Diagramma -->
            <section class="p-6 rounded-lg shadow-md bg-white">
                <h2 class="text-xl font-bold mb-4 text-blue-700">ðŸ“ˆ Bozor Diagrammasi</h2>
                <div id="charts-widget" class="w-full h-96 rounded-lg overflow-hidden">
                    <script src="https://widgets.tradingeconomics.com/static/charts-widget.js" async>
                    {
                        "symbols": ["USDEUR:CUR", "XAUUSD:CUR", "BTCUSD:CUR"],
                        "width": "100%",
                        "height": "100%",
                        "header": true,
                        "calendar": true
                    }
                    </script>
                </div>
            </section>

        </div>
        {% endblock %}
    </main>

    <!-- JS -->
    <script>
        // Profil menyusini ochish
        document.getElementById('profileBtn')?.addEventListener('click', () => {
            document.getElementById('profileMenu').classList.toggle('hidden');
        });

        // Profil menyusini body bosilganda yopish
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('profileMenu');
            const btn = document.getElementById('profileBtn');
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // Narxlarni olish
        async function loadPrices() {
            try {
                let response = await fetch("{% url 'get_prices' %}");
                let data = await response.json();

                let pricesList = document.getElementById("prices-list");
                pricesList.innerHTML = "";

                if (!data.prices || Object.keys(data.prices).length === 0) {
                    pricesList.innerHTML = "<li>Hozircha narxlar mavjud emas.</li>";
                } else {
                    for (const [pair, price] of Object.entries(data.prices)) {
                        pricesList.innerHTML += `
                            <li class="flex justify-between border-b pb-1 mb-1">
                                <span class="font-semibold">${pair}</span>
                                <span class="text-green-500">${price}</span>
                            </li>`;
                    }
                }

                document.getElementById("update-time").innerText = data.updated;
            } catch (error) {
                console.error("Narxlarni olishda xato:", error);
                document.getElementById("prices-list").innerHTML = "<li>Narxlarni yuklab boâ€˜lmadi.</li>";
            }
        }

        loadPrices();
        setInterval(loadPrices, 30000);
    </script>

</body>

</html>
